# Backend для приложения с объявлениями

> [Ссылка на задание от Нетология](README_netology.md)

## Описание проекта

Этот проект представляет собой бэкенд для мобильного приложения с объявлениями, реализованный с использованием Django и Django REST Framework (DRF). Основная задача приложения — предоставление функциональности для создания, просмотра, фильтрации и управления объявлениями пользователями. 

### Основные возможности:
- Создание и просмотр объявлений.
- Фильтрация объявлений по дате создания и статусу.
- Ограничения на количество открытых объявлений у пользователя.
- Реализована аутентификация через токен (`TokenAuthentication`).
- Поддержка добавления объявлений в избранное.
- Реализованы ограничения на количество запросов для авторизованных и неавторизованных пользователей.
- Дополнительные права для администраторов (удаление и изменение всех объявлений).
- Добавлен статус черновика (`DRAFT`), который позволяет сохранять объявления, доступные только автору.

## Техническая реализация

### Основные технологии:
- **Django**: как основной веб-фреймворк.
- **Django REST Framework (DRF)**: для создания API.
- **PostgreSQL**: для работы с базой данных.
- **django-filter**: для фильтрации данных в API.
- **TokenAuthentication**: для аутентификации пользователей через токены.
  
### Основные сущности:
- **Объявления (Advertisements)**: пользователи могут создавать, редактировать и удалять объявления.
- **Избранные объявления**: пользователи могут добавлять объявления в избранное, кроме своих.
- **Пользователи (Users)**: система управления пользователями и аутентификацией с помощью токенов.
  
### Дополнительные функции:
- **Фильтрация**: объявления можно фильтровать по дате создания и статусу (открытое/закрытое).
- **Статус объявления**: существует несколько статусов для объявления — `OPEN`, `CLOSED`, `DRAFT`. Статус `DRAFT` позволяет сохранять объявление как черновик, который виден только автору.
- **Ограничения на количество запросов**: реализованы лимиты на количество запросов:
  - Для неавторизованных пользователей — 10 запросов в минуту.
  - Для авторизованных — 20 запросов в минуту.
- **Ограничения на количество открытых объявлений**: пользователи могут иметь не более 10 открытых объявлений одновременно.
- **Права доступа**: только автор объявления может его изменять или удалять. Администраторы могут управлять любыми объявлениями.

## Основные модели

### Модель `Advertisement`

```python
class Advertisement(models.Model):
    title = models.TextField()
    description = models.TextField(default='')
    status = models.TextField(choices=AdvertisementStatusChoices.choices, default=AdvertisementStatusChoices.OPEN)
    creator = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

### Модель `FavoriteAdvertisement`
```python
class FavoriteAdvertisement(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    advertisement = models.ForeignKey(Advertisement, on_delete=models.CASCADE)
    
    class Meta:
        unique_together = ('user', 'advertisement')
```

## Аутентификация и права доступа

Проект использует `TokenAuthentication`, который позволяет пользователям аутентифицироваться с помощью токенов. Для аутентификации необходимо:

1. Создать пользователя через админку или с помощью API.
2. Создать токен для пользователя через админку.
3. Использовать полученный токен для авторизации в запросах (в заголовке запроса передавать `Authorization: Token <your_token>`).

### Пример запроса с токеном:
```bash
GET /api/advertisements/
Authorization: Token 451937686be91c38e77fb433bdf5fc0e972db1e2
```

### Права доступа:
- **Неавторизованные пользователи**: могут просматривать объявления, но не могут создавать или изменять их.
- **Авторизованные пользователи**: могут создавать, изменять и удалять свои объявления.
- **Администраторы**: могут изменять и удалять любые объявления.

## Фильтрация объявлений

Для фильтрации объявлений используется библиотека `django-filter`. Вы можете фильтровать объявления по следующим полям:

- **Дата создания (created_at)**: фильтрация по диапазону дат.
- **Статус (status)**: фильтрация по статусу (`OPEN`, `CLOSED`, `DRAFT`).
- **Создатель (creator)**: фильтрация по ID пользователя.

Пример использования фильтрации:

```bash
GET /api/advertisements/?created_at_after=2024-09-01&status=OPEN&creator=1
```

## Ограничение запросов (throttling)

Для защиты приложения от злоумышленников и бот-атак введены ограничения на количество запросов:
- Для неавторизованных пользователей — 10 запросов в минуту.
- Для авторизованных пользователей — 20 запросов в минуту.

Эти лимиты настроены в файле конфигурации `settings.py`:
```python
REST_FRAMEWORK = {
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.UserRateThrottle',
        'rest_framework.throttling.AnonRateThrottle'
    ],
    'DEFAULT_THROTTLE_RATES': {
        'user': '20/minute',
        'anon': '10/minute'
    }
}
```

## Избранные объявления

Пользователи могут добавлять объявления в избранное, кроме собственных. Для добавления объявления в избранное используется следующий эндпоинт:

### Добавить в избранное:
```bash
POST /api/advertisements/{id}/t_fav/
Authorization: Token <your_token>
```

### Получение списка избранных объявлений:
```bash
GET /api/advertisements/favorites/
Authorization: Token <your_token>
```

## Дополнительные задания

### Реализованные функции:
1. **Статус черновика (DRAFT)**: пока объявление имеет статус черновика, его видит только автор.
2. **Функциональность для админов**: администраторы могут изменять и удалять любые объявления.
3. **Избранные объявления**: пользователи могут добавлять объявления в избранное, а также фильтровать по избранным.

## Установка и запуск проекта

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка базы данных и миграции
```bash
python manage.py migrate
```

### Запуск сервера
```bash
python manage.py runserver
```

## Примеры запросов

### Получение списка объявлений:
```bash
GET /api/advertisements/
```

### Создание объявления:
```bash
POST /api/advertisements/
Authorization: Token <your_token>

{
  "title": "Продам велосипед",
  "description": "Хорошее состояние, срочно"
}
```

### Фильтрация по дате:
```bash
GET /api/advertisements/?created_at_after=2024-09-01
```

### Добавление в избранное:
```bash
POST /api/advertisements/{id}/t_fav/
Authorization: Token <your_token>
```